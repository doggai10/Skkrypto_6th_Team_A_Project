{"ast":null,"code":"var _toConsumableArray = require(\"/Users/kimdoheon/IdeaProjects/skkrypto/Back_End/demo/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/toConsumableArray\");\n\nvar _createForOfIteratorHelper = require(\"/Users/kimdoheon/IdeaProjects/skkrypto/Back_End/demo/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\n/*\n    Copyright 2020 The caver-js Authors\n    This file is part of the caver-js library.\n\n    The caver-js library is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Lesser General Public License as published by\n    the Free Software Foundation, either version 3 of the License, or\n    (at your option) any later version.\n\n    The caver-js library is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n    GNU Lesser General Public License for more details.\n\n    You should have received a copy of the GNU Lesser General Public License\n    along with the caver-js. If not, see <http://www.gnu.org/licenses/>.\n*/\nvar _ = require('lodash');\n\nvar scrypt = require('scrypt-js');\n\nvar uuid = require('uuid');\n\nvar cryp = typeof global === 'undefined' ? require('crypto-browserify') : require('crypto');\n\nvar utils = require('../../../caver-utils');\n\nvar PrivateKey = require('./privateKey');\n\nvar KEY_ROLE = {\n  roleTransactionKey: 0,\n  0: 'roleTransactionKey',\n  roleAccountUpdateKey: 1,\n  1: 'roleAccountUpdateKey',\n  roleFeePayerKey: 2,\n  2: 'roleFeePayerKey',\n  roleLast: 3\n};\nvar MAXIMUM_KEY_NUM = 10;\n\nvar isMultipleKeysFormat = function isMultipleKeysFormat(keys) {\n  if (!_.isArray(keys)) return false;\n  return keys.every(function (key) {\n    return _.isString(key);\n  });\n};\n\nvar isRoleBasedKeysFormat = function isRoleBasedKeysFormat(roledBasedKeyArray) {\n  if (!_.isArray(roledBasedKeyArray)) return false;\n  if (roledBasedKeyArray.length > KEY_ROLE.roleLast) return false;\n  return roledBasedKeyArray.every(function (arr) {\n    return _.isArray(arr);\n  });\n};\n\nvar validateForSigning = function validateForSigning(hash, chainId) {\n  if (!utils.isValidHashStrict(hash)) throw new Error(\"Invalid transaction hash: \".concat(hash));\n\n  if (chainId === undefined) {\n    throw new Error(\"chainId should be defined to sign.\");\n  }\n};\n\nvar validateIndexWithKeys = function validateIndexWithKeys(index, keyLength) {\n  if (!_.isNumber(index)) throw new Error(\"Invalid type of index(\".concat(index, \"): index should be number type.\"));\n  if (index < 0) throw new Error(\"Invalid index(\".concat(index, \"): index cannot be negative.\"));\n  if (index >= keyLength) throw new Error(\"Invalid index(\".concat(index, \"): index must be less than the length of keys(\").concat(keyLength, \").\"));\n};\n\nvar decryptKey = function decryptKey(encryptedArray, password) {\n  if (!encryptedArray || encryptedArray.length === 0) return undefined;\n  var decryptedArray = [];\n\n  var _iterator = _createForOfIteratorHelper(encryptedArray),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var encrypted = _step.value;\n      var derivedKey = void 0;\n      var kdfparams = void 0;\n      /**\n       * Supported kdf modules are the following:\n       * 1) pbkdf2\n       * 2) scrypt\n       */\n\n      if (encrypted.kdf === 'scrypt') {\n        kdfparams = encrypted.kdfparams; // FIXME: support progress reporting callback\n\n        derivedKey = scrypt.syncScrypt(Buffer.from(password), Buffer.from(kdfparams.salt, 'hex'), kdfparams.n, kdfparams.r, kdfparams.p, kdfparams.dklen);\n      } else if (encrypted.kdf === 'pbkdf2') {\n        kdfparams = encrypted.kdfparams;\n\n        if (kdfparams.prf !== 'hmac-sha256') {\n          throw new Error('Unsupported parameters to PBKDF2');\n        }\n\n        derivedKey = cryp.pbkdf2Sync(Buffer.from(password), Buffer.from(kdfparams.salt, 'hex'), kdfparams.c, kdfparams.dklen, 'sha256');\n      } else {\n        throw new Error('Unsupported key derivation scheme');\n      }\n\n      var ciphertext = Buffer.from(encrypted.ciphertext, 'hex');\n      var mac = utils.sha3(Buffer.from([].concat(_toConsumableArray(derivedKey.slice(16, 32)), _toConsumableArray(ciphertext)))).replace('0x', '');\n\n      if (mac !== encrypted.mac) {\n        throw new Error('Key derivation failed - possibly wrong password');\n      }\n\n      var decipher = cryp.createDecipheriv(encrypted.cipher, derivedKey.slice(0, 16), Buffer.from(encrypted.cipherparams.iv, 'hex'));\n      decryptedArray.push(\"0x\".concat(Buffer.from([].concat(_toConsumableArray(decipher.update(ciphertext)), _toConsumableArray(decipher.final()))).toString('hex')));\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  return decryptedArray;\n};\n\nvar encryptKey = function encryptKey(privateKey, password, options) {\n  var encryptedArray = [];\n  if (!privateKey) return encryptedArray;\n  var privateKeyArray = _.isArray(privateKey) ? privateKey : [privateKey];\n\n  for (var i = 0; i < privateKeyArray.length; i++) {\n    var salt = options.salt || cryp.randomBytes(32);\n    var iv = options.iv || cryp.randomBytes(16);\n    var derivedKey = void 0;\n    var kdf = options.kdf || 'scrypt';\n    var kdfparams = {\n      dklen: options.dklen || 32,\n      salt: salt.toString('hex')\n    };\n    /**\n     * Supported kdf modules are the following:\n     * 1) pbkdf2\n     * 2) scrypt - default\n     */\n\n    if (kdf === 'pbkdf2') {\n      kdfparams.c = options.c || 262144;\n      kdfparams.prf = 'hmac-sha256';\n      derivedKey = cryp.pbkdf2Sync(Buffer.from(password), Buffer.from(kdfparams.salt, 'hex'), kdfparams.c, kdfparams.dklen, 'sha256');\n    } else if (kdf === 'scrypt') {\n      // FIXME: support progress reporting callback\n      kdfparams.n = options.n || 4096; // 2048 4096 8192 16384\n\n      kdfparams.r = options.r || 8;\n      kdfparams.p = options.p || 1;\n      derivedKey = scrypt.syncScrypt(Buffer.from(password), Buffer.from(kdfparams.salt, 'hex'), kdfparams.n, kdfparams.r, kdfparams.p, kdfparams.dklen);\n    } else {\n      throw new Error('Unsupported kdf');\n    }\n\n    var cipher = cryp.createCipheriv(options.cipher || 'aes-128-ctr', derivedKey.slice(0, 16), iv);\n\n    if (!cipher) {\n      throw new Error('Unsupported cipher');\n    }\n\n    var prv = privateKeyArray[i];\n    if (privateKeyArray[i] instanceof PrivateKey) prv = privateKeyArray[i].privateKey;\n    var ciphertext = Buffer.from([].concat(_toConsumableArray(cipher.update(Buffer.from(prv.replace('0x', ''), 'hex'))), _toConsumableArray(cipher.final())));\n    var mac = utils.sha3(Buffer.from([].concat(_toConsumableArray(derivedKey.slice(16, 32)), _toConsumableArray(ciphertext)))).replace('0x', '');\n    encryptedArray.push({\n      ciphertext: ciphertext.toString('hex'),\n      cipherparams: {\n        iv: iv.toString('hex')\n      },\n      cipher: options.cipher || 'aes-128-ctr',\n      kdf: kdf,\n      kdfparams: kdfparams,\n      mac: mac.toString('hex')\n    });\n  }\n\n  return encryptedArray;\n};\n\nvar formatEncrypted = function formatEncrypted(version, address, keyringOrCrypto, options) {\n  var keystore = {\n    version: version,\n    id: uuid.v4({\n      random: options.uuid || cryp.randomBytes(16)\n    }),\n    address: address.toLowerCase()\n  };\n\n  if (version === 3) {\n    keystore.crypto = keyringOrCrypto;\n  } else if (version === 4) {\n    keystore.keyring = keyringOrCrypto;\n  } else {\n    throw new Error(\"Unsupported version of keystore\");\n  }\n\n  return keystore;\n};\n\nmodule.exports = {\n  KEY_ROLE: KEY_ROLE,\n  MAXIMUM_KEY_NUM: MAXIMUM_KEY_NUM,\n  isMultipleKeysFormat: isMultipleKeysFormat,\n  isRoleBasedKeysFormat: isRoleBasedKeysFormat,\n  validateForSigning: validateForSigning,\n  validateIndexWithKeys: validateIndexWithKeys,\n  decryptKey: decryptKey,\n  encryptKey: encryptKey,\n  formatEncrypted: formatEncrypted\n};","map":{"version":3,"sources":["/Users/kimdoheon/IdeaProjects/skkrypto/Back_End/demo/frontend/node_modules/caver-js/packages/caver-wallet/src/keyring/keyringHelper.js"],"names":["_","require","scrypt","uuid","cryp","global","utils","PrivateKey","KEY_ROLE","roleTransactionKey","roleAccountUpdateKey","roleFeePayerKey","roleLast","MAXIMUM_KEY_NUM","isMultipleKeysFormat","keys","isArray","every","key","isString","isRoleBasedKeysFormat","roledBasedKeyArray","length","arr","validateForSigning","hash","chainId","isValidHashStrict","Error","undefined","validateIndexWithKeys","index","keyLength","isNumber","decryptKey","encryptedArray","password","decryptedArray","encrypted","derivedKey","kdfparams","kdf","syncScrypt","Buffer","from","salt","n","r","p","dklen","prf","pbkdf2Sync","c","ciphertext","mac","sha3","slice","replace","decipher","createDecipheriv","cipher","cipherparams","iv","push","update","final","toString","encryptKey","privateKey","options","privateKeyArray","i","randomBytes","createCipheriv","prv","formatEncrypted","version","address","keyringOrCrypto","keystore","id","v4","random","toLowerCase","crypto","keyring","module","exports"],"mappings":"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","sourcesContent":["/*\n    Copyright 2020 The caver-js Authors\n    This file is part of the caver-js library.\n\n    The caver-js library is free software: you can redistribute it and/or modify\n    it under the terms of the GNU Lesser General Public License as published by\n    the Free Software Foundation, either version 3 of the License, or\n    (at your option) any later version.\n\n    The caver-js library is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n    GNU Lesser General Public License for more details.\n\n    You should have received a copy of the GNU Lesser General Public License\n    along with the caver-js. If not, see <http://www.gnu.org/licenses/>.\n*/\n\nconst _ = require('lodash')\nconst scrypt = require('scrypt-js')\nconst uuid = require('uuid')\nconst cryp = typeof global === 'undefined' ? require('crypto-browserify') : require('crypto')\nconst utils = require('../../../caver-utils')\nconst PrivateKey = require('./privateKey')\n\nconst KEY_ROLE = {\n    roleTransactionKey: 0,\n    0: 'roleTransactionKey',\n    roleAccountUpdateKey: 1,\n    1: 'roleAccountUpdateKey',\n    roleFeePayerKey: 2,\n    2: 'roleFeePayerKey',\n    roleLast: 3,\n}\n\nconst MAXIMUM_KEY_NUM = 10\n\nconst isMultipleKeysFormat = keys => {\n    if (!_.isArray(keys)) return false\n    return keys.every(key => {\n        return _.isString(key)\n    })\n}\n\nconst isRoleBasedKeysFormat = roledBasedKeyArray => {\n    if (!_.isArray(roledBasedKeyArray)) return false\n    if (roledBasedKeyArray.length > KEY_ROLE.roleLast) return false\n\n    return roledBasedKeyArray.every(arr => {\n        return _.isArray(arr)\n    })\n}\n\nconst validateForSigning = (hash, chainId) => {\n    if (!utils.isValidHashStrict(hash)) throw new Error(`Invalid transaction hash: ${hash}`)\n\n    if (chainId === undefined) {\n        throw new Error(`chainId should be defined to sign.`)\n    }\n}\n\nconst validateIndexWithKeys = (index, keyLength) => {\n    if (!_.isNumber(index)) throw new Error(`Invalid type of index(${index}): index should be number type.`)\n    if (index < 0) throw new Error(`Invalid index(${index}): index cannot be negative.`)\n    if (index >= keyLength) throw new Error(`Invalid index(${index}): index must be less than the length of keys(${keyLength}).`)\n}\n\nconst decryptKey = (encryptedArray, password) => {\n    if (!encryptedArray || encryptedArray.length === 0) return undefined\n\n    const decryptedArray = []\n    for (const encrypted of encryptedArray) {\n        let derivedKey\n        let kdfparams\n        /**\n         * Supported kdf modules are the following:\n         * 1) pbkdf2\n         * 2) scrypt\n         */\n        if (encrypted.kdf === 'scrypt') {\n            kdfparams = encrypted.kdfparams\n\n            // FIXME: support progress reporting callback\n            derivedKey = scrypt.syncScrypt(\n                Buffer.from(password),\n                Buffer.from(kdfparams.salt, 'hex'),\n                kdfparams.n,\n                kdfparams.r,\n                kdfparams.p,\n                kdfparams.dklen\n            )\n        } else if (encrypted.kdf === 'pbkdf2') {\n            kdfparams = encrypted.kdfparams\n\n            if (kdfparams.prf !== 'hmac-sha256') {\n                throw new Error('Unsupported parameters to PBKDF2')\n            }\n\n            derivedKey = cryp.pbkdf2Sync(Buffer.from(password), Buffer.from(kdfparams.salt, 'hex'), kdfparams.c, kdfparams.dklen, 'sha256')\n        } else {\n            throw new Error('Unsupported key derivation scheme')\n        }\n\n        const ciphertext = Buffer.from(encrypted.ciphertext, 'hex')\n\n        const mac = utils.sha3(Buffer.from([...derivedKey.slice(16, 32), ...ciphertext])).replace('0x', '')\n        if (mac !== encrypted.mac) {\n            throw new Error('Key derivation failed - possibly wrong password')\n        }\n\n        const decipher = cryp.createDecipheriv(encrypted.cipher, derivedKey.slice(0, 16), Buffer.from(encrypted.cipherparams.iv, 'hex'))\n        decryptedArray.push(`0x${Buffer.from([...decipher.update(ciphertext), ...decipher.final()]).toString('hex')}`)\n    }\n    return decryptedArray\n}\n\nconst encryptKey = (privateKey, password, options) => {\n    const encryptedArray = []\n\n    if (!privateKey) return encryptedArray\n\n    const privateKeyArray = _.isArray(privateKey) ? privateKey : [privateKey]\n\n    for (let i = 0; i < privateKeyArray.length; i++) {\n        const salt = options.salt || cryp.randomBytes(32)\n        const iv = options.iv || cryp.randomBytes(16)\n\n        let derivedKey\n        const kdf = options.kdf || 'scrypt'\n        const kdfparams = {\n            dklen: options.dklen || 32,\n            salt: salt.toString('hex'),\n        }\n\n        /**\n         * Supported kdf modules are the following:\n         * 1) pbkdf2\n         * 2) scrypt - default\n         */\n        if (kdf === 'pbkdf2') {\n            kdfparams.c = options.c || 262144\n            kdfparams.prf = 'hmac-sha256'\n            derivedKey = cryp.pbkdf2Sync(Buffer.from(password), Buffer.from(kdfparams.salt, 'hex'), kdfparams.c, kdfparams.dklen, 'sha256')\n        } else if (kdf === 'scrypt') {\n            // FIXME: support progress reporting callback\n            kdfparams.n = options.n || 4096 // 2048 4096 8192 16384\n            kdfparams.r = options.r || 8\n            kdfparams.p = options.p || 1\n            derivedKey = scrypt.syncScrypt(\n                Buffer.from(password),\n                Buffer.from(kdfparams.salt, 'hex'),\n                kdfparams.n,\n                kdfparams.r,\n                kdfparams.p,\n                kdfparams.dklen\n            )\n        } else {\n            throw new Error('Unsupported kdf')\n        }\n\n        const cipher = cryp.createCipheriv(options.cipher || 'aes-128-ctr', derivedKey.slice(0, 16), iv)\n        if (!cipher) {\n            throw new Error('Unsupported cipher')\n        }\n\n        let prv = privateKeyArray[i]\n        if (privateKeyArray[i] instanceof PrivateKey) prv = privateKeyArray[i].privateKey\n        const ciphertext = Buffer.from([...cipher.update(Buffer.from(prv.replace('0x', ''), 'hex')), ...cipher.final()])\n\n        const mac = utils.sha3(Buffer.from([...derivedKey.slice(16, 32), ...ciphertext])).replace('0x', '')\n\n        encryptedArray.push({\n            ciphertext: ciphertext.toString('hex'),\n            cipherparams: {\n                iv: iv.toString('hex'),\n            },\n            cipher: options.cipher || 'aes-128-ctr',\n            kdf,\n            kdfparams,\n            mac: mac.toString('hex'),\n        })\n    }\n\n    return encryptedArray\n}\n\nconst formatEncrypted = (version, address, keyringOrCrypto, options) => {\n    const keystore = {\n        version,\n        id: uuid.v4({ random: options.uuid || cryp.randomBytes(16) }),\n        address: address.toLowerCase(),\n    }\n\n    if (version === 3) {\n        keystore.crypto = keyringOrCrypto\n    } else if (version === 4) {\n        keystore.keyring = keyringOrCrypto\n    } else {\n        throw new Error(`Unsupported version of keystore`)\n    }\n\n    return keystore\n}\n\nmodule.exports = {\n    KEY_ROLE,\n    MAXIMUM_KEY_NUM,\n    isMultipleKeysFormat,\n    isRoleBasedKeysFormat,\n    validateForSigning,\n    validateIndexWithKeys,\n    decryptKey,\n    encryptKey,\n    formatEncrypted,\n}\n"]},"metadata":{},"sourceType":"script"}